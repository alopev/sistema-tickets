{% extends "layouts/page_shell.html" %}

{% block content %}
<!-- Preloader -->
<div id="settings-preloader"
    style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.95); z-index: 99999; display: flex; justify-content: center; align-items: center; flex-direction: column;">
    <div class="loader-3d"
        style="position: relative; width: calc(32px * 4 + 4px * 6); height: calc(32px * 2 + 4px * 4); transform-style: preserve-3d; transform: rotateX(-20deg) rotateY(-45deg);">
        <div class="box"
            style="position: absolute; width: 32px; height: 32px; border-radius: 4px; background: linear-gradient(135deg, #a855f7 0%, #9333ea 100%); transform-style: preserve-3d; animation: flip 1600ms cubic-bezier(0.25, 0.46, 0.45, 0.94) infinite; box-shadow: 0 0 20px rgba(168, 85, 247, 0.4); left: 0; top: 0; animation-delay: -1400ms;">
        </div>
        <div class="box"
            style="position: absolute; width: 32px; height: 32px; border-radius: 4px; background: linear-gradient(135deg, #a855f7 0%, #9333ea 100%); transform-style: preserve-3d; animation: flip 1600ms cubic-bezier(0.25, 0.46, 0.45, 0.94) infinite; box-shadow: 0 0 20px rgba(168, 85, 247, 0.4); left: calc(32px * 1 + 4px * 2); top: 0; animation-delay: -1200ms;">
        </div>
        <div class="box"
            style="position: absolute; width: 32px; height: 32px; border-radius: 4px; background: linear-gradient(135deg, #a855f7 0%, #9333ea 100%); transform-style: preserve-3d; animation: flip 1600ms cubic-bezier(0.25, 0.46, 0.45, 0.94) infinite; box-shadow: 0 0 20px rgba(168, 85, 247, 0.4); left: calc(32px * 2 + 4px * 4); top: 0; animation-delay: -1000ms;">
        </div>
        <div class="box"
            style="position: absolute; width: 32px; height: 32px; border-radius: 4px; background: linear-gradient(135deg, #a855f7 0%, #9333ea 100%); transform-style: preserve-3d; animation: flip 1600ms cubic-bezier(0.25, 0.46, 0.45, 0.94) infinite; box-shadow: 0 0 20px rgba(168, 85, 247, 0.4); left: calc(32px * 3 + 4px * 6); top: 0; animation-delay: -800ms;">
        </div>
        <div class="box"
            style="position: absolute; width: 32px; height: 32px; border-radius: 4px; background: linear-gradient(135deg, #a855f7 0%, #9333ea 100%); transform-style: preserve-3d; animation: flip 1600ms cubic-bezier(0.25, 0.46, 0.45, 0.94) infinite; box-shadow: 0 0 20px rgba(168, 85, 247, 0.4); left: 0; top: calc(32px * 1 + 4px * 2); animation-delay: -600ms;">
        </div>
        <div class="box"
            style="position: absolute; width: 32px; height: 32px; border-radius: 4px; background: linear-gradient(135deg, #a855f7 0%, #9333ea 100%); transform-style: preserve-3d; animation: flip 1600ms cubic-bezier(0.25, 0.46, 0.45, 0.94) infinite; box-shadow: 0 0 20px rgba(168, 85, 247, 0.4); left: calc(32px * 1 + 4px * 2); top: calc(32px * 1 + 4px * 2); animation-delay: -400ms;">
        </div>
        <div class="box"
            style="position: absolute; width: 32px; height: 32px; border-radius: 4px; background: linear-gradient(135deg, #a855f7 0%, #9333ea 100%); transform-style: preserve-3d; animation: flip 1600ms cubic-bezier(0.25, 0.46, 0.45, 0.94) infinite; box-shadow: 0 0 20px rgba(168, 85, 247, 0.4); left: calc(32px * 2 + 4px * 4); top: calc(32px * 1 + 4px * 2); animation-delay: -200ms;">
        </div>
        <div class="box"
            style="position: absolute; width: 32px; height: 32px; border-radius: 4px; background: linear-gradient(135deg, #a855f7 0%, #9333ea 100%); transform-style: preserve-3d; animation: flip 1600ms cubic-bezier(0.25, 0.46, 0.45, 0.94) infinite; box-shadow: 0 0 20px rgba(168, 85, 247, 0.4); left: calc(32px * 3 + 4px * 6); top: calc(32px * 1 + 4px * 2); animation-delay: 0ms;">
        </div>
    </div>
    <div
        style="margin-top: 60px; font-size: 18px; font-weight: 600; color: var(--c-purple); letter-spacing: 2px; text-transform: uppercase;">
        CARGANDO CONFIGURACIÓN</div>
</div>

<!-- Page Title -->
<h1 class="page-title">
    <i class="fa-solid fa-gear"></i> Configuración del Sistema
</h1>

<!-- Stats Cards Mini -->
<div class="stats-grid">
    <div class="stat-card stat-purple">
        <div class="stat-title">Proyecto</div>
        <div class="stat-value">{{ settings.project_name[:15] }}...</div>
    </div>
    <div class="stat-card stat-cyan">
        <div class="stat-title">Color Primario</div>
        <div class="stat-value">
            <div
                style="display: inline-block; width: 24px; height: 24px; border-radius: 4px; background: {{ settings.primary_color }}; border: 1px solid rgba(0,0,0,0.1);">
            </div>
        </div>
    </div>
    <div class="stat-card stat-green">
        <div class="stat-title">Logo</div>
        <div class="stat-value"><i class="fa-solid fa-image"></i></div>
    </div>
    <div class="stat-card stat-amber">
        <div class="stat-title">Favicon</div>
        <div class="stat-value"><i class="fa-solid fa-star"></i></div>
    </div>
</div>

<!-- Settings Form -->
<div class="desktop-card settings-card">
    <form method="POST" enctype="multipart/form-data" id="settingsForm">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />

        <!-- Tabs Navigation -->
        <div class="settings-tabs">
            <button type="button" class="tab-btn active" data-tab="general">
                <i class="fa-solid fa-circle-info"></i> General
            </button>
            <button type="button" class="tab-btn" data-tab="colors">
                <i class="fa-solid fa-palette"></i> Colores
            </button>
            <button type="button" class="tab-btn" data-tab="branding">
                <i class="fa-solid fa-image"></i> Logos
            </button>
        </div>

        <!-- Tab: General -->
        <div class="tab-content active" id="tab-general">
            <div class="settings-section">
                <h3 class="settings-section-title">
                    <i class="fa-solid fa-file-signature"></i> Información General
                </h3>
                <div class="form-group">
                    <label for="project_name" class="form-label">
                        <i class="fa-solid fa-tag"></i> Nombre del Proyecto
                    </label>
                    <input type="text" class="form-input" id="project_name" name="project_name"
                        value="{{ settings.project_name }}" required placeholder="Ej: Sistema de Tickets">
                    <small class="form-help">Este nombre aparecerá en la barra superior y en el título del
                        navegador.</small>
                </div>
            </div>
        </div>

        <!-- Tab: Colors -->
        <div class="tab-content" id="tab-colors">
            <div class="settings-section">
                <h3 class="settings-section-title">
                    <i class="fa-solid fa-palette"></i> Colores del Sistema
                </h3>
                <div class="color-grid">
                    <div class="color-picker-group">
                        <label for="primary_color" class="form-label">
                            <i class="fa-solid fa-circle" style="color: {{ settings.primary_color }};"></i> Color
                            Primario
                        </label>
                        <div class="color-input-wrapper">
                            <input type="color" class="form-color" id="primary_color" name="primary_color"
                                value="{{ settings.primary_color }}">
                            <input type="text" class="form-input color-hex" value="{{ settings.primary_color }}"
                                readonly>
                        </div>
                    </div>

                    <div class="color-picker-group">
                        <label for="secondary_color" class="form-label">
                            <i class="fa-solid fa-circle" style="color: {{ settings.secondary_color }};"></i> Color
                            Secundario
                        </label>
                        <div class="color-input-wrapper">
                            <input type="color" class="form-color" id="secondary_color" name="secondary_color"
                                value="{{ settings.secondary_color }}">
                            <input type="text" class="form-input color-hex" value="{{ settings.secondary_color }}"
                                readonly>
                        </div>
                    </div>
                </div>
            </div>

            <div class="settings-section">
                <h3 class="settings-section-title">
                    <i class="fa-solid fa-chart-pie"></i> Colores del Dashboard
                </h3>
                <small class="form-help">Personaliza los colores de las tarjetas de estadísticas en el
                    dashboard.</small>
                <div class="color-grid dashboard-colors">
                    <div class="color-picker-group">
                        <label for="card_total_color" class="form-label">
                            <i class="fa-solid fa-circle-check" style="color: {{ settings.card_total_color }};"></i>
                            Total Tickets
                        </label>
                        <div class="color-input-wrapper">
                            <input type="color" class="form-color" id="card_total_color" name="card_total_color"
                                value="{{ settings.card_total_color }}">
                            <input type="text" class="form-input color-hex" value="{{ settings.card_total_color }}"
                                readonly>
                        </div>
                    </div>

                    <div class="color-picker-group">
                        <label for="card_open_color" class="form-label">
                            <i class="fa-solid fa-circle-exclamation"
                                style="color: {{ settings.card_open_color }};"></i> Abiertos
                        </label>
                        <div class="color-input-wrapper">
                            <input type="color" class="form-color" id="card_open_color" name="card_open_color"
                                value="{{ settings.card_open_color }}">
                            <input type="text" class="form-input color-hex" value="{{ settings.card_open_color }}"
                                readonly>
                        </div>
                    </div>

                    <div class="color-picker-group">
                        <label for="card_process_color" class="form-label">
                            <i class="fa-solid fa-circle-pause" style="color: {{ settings.card_process_color }};"></i>
                            En Proceso
                        </label>
                        <div class="color-input-wrapper">
                            <input type="color" class="form-color" id="card_process_color" name="card_process_color"
                                value="{{ settings.card_process_color }}">
                            <input type="text" class="form-input color-hex" value="{{ settings.card_process_color }}"
                                readonly>
                        </div>
                    </div>

                    <div class="color-picker-group">
                        <label for="card_closed_color" class="form-label">
                            <i class="fa-solid fa-circle-check" style="color: {{ settings.card_closed_color }};"></i>
                            Cerrados
                        </label>
                        <div class="color-input-wrapper">
                            <input type="color" class="form-color" id="card_closed_color" name="card_closed_color"
                                value="{{ settings.card_closed_color }}">
                            <input type="text" class="form-input color-hex" value="{{ settings.card_closed_color }}"
                                readonly>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab: Branding -->
        <div class="tab-content" id="tab-branding">
            <div class="settings-section">
                <h3 class="settings-section-title">
                    <i class="fa-solid fa-image"></i> Logo del Sistema
                </h3>
                <div class="upload-group">
                    <div class="upload-preview">
                        <img src="{{ url_for('static', filename=settings.logo_path) }}" alt="Logo Actual"
                            id="logoPreview" class="preview-image">
                    </div>
                    <div class="upload-controls">
                        <label for="logo" class="form-label">
                            <i class="fa-solid fa-upload"></i> Subir Nuevo Logo
                        </label>
                        <input class="form-file" type="file" id="logo" name="logo" accept="image/*"
                            onchange="previewImage(event, 'logoPreview')">
                        <small class="form-help">
                            <i class="fa-solid fa-info-circle"></i>
                            Formatos: JPG, PNG, SVG. Tamaño recomendado: 200x50px
                        </small>
                    </div>
                </div>
            </div>

            <div class="settings-section">
                <h3 class="settings-section-title">
                    <i class="fa-solid fa-star"></i> Favicon
                </h3>
                <div class="upload-group">
                    <div class="upload-preview favicon-preview">
                        <img src="{{ url_for('static', filename=settings.favicon_path) }}" alt="Favicon Actual"
                            id="faviconPreview" class="preview-image-small">
                    </div>
                    <div class="upload-controls">
                        <label for="favicon" class="form-label">
                            <i class="fa-solid fa-upload"></i> Subir Nuevo Favicon
                        </label>
                        <input class="form-file" type="file" id="favicon" name="favicon" accept=".ico,.png"
                            onchange="previewImage(event, 'faviconPreview')">
                        <small class="form-help">
                            <i class="fa-solid fa-info-circle"></i>
                            Formatos: ICO, PNG. Tamaño recomendado: 32x32px o 64x64px
                        </small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Form Actions -->
        <div class="form-actions">
            <a href="{{ url_for('main.index') }}" class="btn-secondary">
                <i class="fa-solid fa-xmark"></i> Cancelar
            </a>
            <button type="submit" class="btn-primary">
                <i class="fa-solid fa-save"></i> Guardar Cambios
            </button>
        </div>
    </form>
</div>
</div>

<style>
    /* Settings Page Specific Styles */
    .settings-card {
        margin-top: 20px;
    }

    .settings-tabs {
        display: flex;
        gap: 8px;
        padding: 16px 16px 0;
        border-bottom: 2px solid rgba(2, 6, 23, .08);
        background: #f8fafc;
        border-radius: 10px 10px 0 0;
    }

    .tab-btn {
        padding: 12px 20px;
        border: none;
        background: transparent;
        color: var(--text-muted);
        font-weight: 600;
        font-size: 14px;
        cursor: pointer;
        border-radius: 8px 8px 0 0;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .tab-btn:hover {
        background: rgba(168, 85, 247, 0.1);
        color: var(--c-purple);
    }

    .tab-btn.active {
        background: white;
        color: var(--c-purple);
        box-shadow: 0 -2px 8px rgba(2, 6, 23, .06);
    }

    .tab-content {
        display: none;
        padding: 24px;
    }

    .tab-content.active {
        display: block;
    }

    .settings-section {
        margin-bottom: 32px;
    }

    .settings-section-title {
        font-size: 18px;
        font-weight: 700;
        color: var(--text-title);
        margin-bottom: 16px;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .settings-section-title i {
        color: var(--c-purple);
    }

    .form-group {
        margin-bottom: 20px;
    }

    .form-label {
        display: block;
        font-size: 13px;
        font-weight: 600;
        color: var(--text-soft);
        margin-bottom: 8px;
    }

    .form-label i {
        margin-right: 6px;
        opacity: 0.7;
    }

    .form-input {
        width: 100%;
        padding: 12px 14px;
        border: 1px solid rgba(2, 6, 23, .12);
        border-radius: 8px;
        font-size: 14px;
        transition: all 0.2s;
        background: white;
    }

    .form-input:focus {
        outline: none;
        border-color: var(--c-purple);
        box-shadow: 0 0 0 3px rgba(168, 85, 247, 0.1);
    }

    .form-help {
        display: block;
        font-size: 12px;
        color: var(--text-muted);
        margin-top: 6px;
    }

    /* Color Pickers */
    .color-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-top: 16px;
    }

    .color-grid.dashboard-colors {
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    }

    .color-picker-group {
        display: flex;
        flex-direction: column;
    }

    .color-input-wrapper {
        display: flex;
        gap: 10px;
        align-items: center;
    }

    .form-color {
        width: 60px;
        height: 44px;
        border: 2px solid rgba(2, 6, 23, .12);
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s;
    }

    .form-color:hover {
        border-color: var(--c-purple);
        transform: scale(1.05);
    }

    .color-hex {
        flex: 1;
        text-align: center;
        font-family: 'Courier New', monospace;
        font-weight: 600;
        background: #f8fafc;
    }

    /* Upload Groups */
    .upload-group {
        display: flex;
        gap: 24px;
        align-items: flex-start;
        padding: 20px;
        background: #f8fafc;
        border-radius: 10px;
        border: 1px solid rgba(2, 6, 23, .08);
    }

    .upload-preview {
        flex: 0 0 200px;
        padding: 16px;
        background: white;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        border: 2px dashed rgba(2, 6, 23, .12);
    }

    .upload-preview.favicon-preview {
        flex: 0 0 80px;
        height: 80px;
    }

    .preview-image {
        max-width: 100%;
        max-height: 60px;
        object-fit: contain;
    }

    .preview-image-small {
        max-width: 48px;
        max-height: 48px;
        object-fit: contain;
    }

    .upload-controls {
        flex: 1;
    }

    .form-file {
        width: 100%;
        padding: 10px 14px;
        border: 1px solid rgba(2, 6, 23, .12);
        border-radius: 8px;
        font-size: 13px;
        background: white;
        cursor: pointer;
    }

    .form-file:hover {
        border-color: var(--c-purple);
    }

    /* Form Actions */
    .form-actions {
        display: flex;
        gap: 12px;
        justify-content: flex-end;
        padding: 20px 24px;
        background: #f8fafc;
        border-top: 1px solid rgba(2, 6, 23, .08);
        border-radius: 0 0 10px 10px;
        margin: 0 -24px -24px;
    }

    .btn-primary,
    .btn-secondary {
        padding: 12px 24px;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        text-decoration: none;
        border: none;
        white-space: nowrap;
    }

    .btn-primary {
        background: linear-gradient(135deg, var(--c-purple) 0%, #9333ea 100%);
        color: white;
    }

    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(168, 85, 247, 0.3);
    }

    .btn-secondary {
        background: white;
        color: var(--text-soft);
        border: 1px solid rgba(2, 6, 23, .12);
    }

    .btn-secondary:hover {
        background: #f8fafc;
        border-color: var(--text-soft);
    }

    /* Responsive */
    @media (max-width: 768px) {
        .settings-tabs {
            flex-direction: column;
        }

        .tab-btn {
            border-radius: 8px;
        }

        .color-grid {
            grid-template-columns: 1fr;
        }

        .upload-group {
            flex-direction: column;
        }

        .upload-preview {
            flex: 0 0 auto;
            width: 100%;
        }
    }
</style>

<script>
    // Tab switching
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            // Remove active from all
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));

            // Add active to clicked
            btn.classList.add('active');
            const tabId = 'tab-' + btn.dataset.tab;
            document.getElementById(tabId).classList.add('active');
        });
    });

    // Update color hex display when color picker changes
    document.querySelectorAll('.form-color').forEach(colorInput => {
        colorInput.addEventListener('input', (e) => {
            const hexInput = e.target.parentElement.querySelector('.color-hex');
            if (hexInput) {
                hexInput.value = e.target.value.toUpperCase();
            }
        });
    });

    // Image preview function
    function previewImage(event, previewId) {
        const input = event.target;
        const preview = document.getElementById(previewId);

        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = (e) => {
                preview.src = e.target.result;
            };
            reader.readAsDataURL(input.files[0]);
        }
    }

    // Form submission with SweetAlert
    document.getElementById('settingsForm').addEventListener('submit', (e) => {
        e.preventDefault();

        const formData = new FormData(e.target);

        Swal.fire({
            title: 'Guardando...',
            text: 'Aplicando configuración del sistema',
            allowOutsideClick: false,
            didOpen: () => {
                Swal.showLoading();
            }
        });

        fetch('{{ url_for("admin.settings") }}', {
            method: 'POST',
            body: formData
        })
            .then(response => {
                if (response.redirected) {
                    Swal.fire({
                        icon: 'success',
                        title: '¡Éxito!',
                        text: 'Configuración guardada correctamente',
                        showConfirmButton: false,
                        timer: 1500
                    }).then(() => {
                        window.location.href = response.url;
                    });
                } else {
                    throw new Error('Error en la respuesta');
                }
            })
            .catch(error => {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'No se pudo guardar la configuración'
                });
            });
    });
</script>

<style>
    @keyframes flip {
        0% {
            transform: rotateY(0deg) rotateX(0deg) translateZ(0);
        }

        25% {
            transform: rotateY(90deg) rotateX(0deg) translateZ(0);
        }

        50% {
            transform: rotateY(180deg) rotateX(0deg) translateZ(0);
        }

        75% {
            transform: rotateY(270deg) rotateX(0deg) translateZ(0);
        }

        100% {
            transform: rotateY(360deg) rotateX(0deg) translateZ(0);
        }
    }
</style>

<script>
    // Hide preloader after page loads
    window.addEventListener('load', function () {
        setTimeout(function () {
            const preloader = document.getElementById('settings-preloader');
            if (preloader) {
                preloader.style.opacity = '0';
                preloader.style.transition = 'opacity 0.5s ease';
                setTimeout(function () {
                    preloader.style.display = 'none';
                }, 500);
            }
        }, 1500); // Wait 1.5 seconds to appreciate the animation
    });
</script>
{% endblock %}